#!/bin/zsh
zmodload -F zsh/zselect b:zselect

add-zsh-hook -d preexec ..znap.auto-compile

(
  local exclude=
  zstyle -s :znap: auto-compile-ignore exclude '|' &&
      exclude="($exclude)"

  private -aU include=()
  private k v
  for k v in "${(@kv)functions_source}"; do
    [[ $v == */$k && $v != $~exclude ]] &&
        include+=( $v )
  done

  .znap.compile $include[@]
) &> /dev/null &|
